# XML to PostgreSQL ETL

Kotlin CLI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ ETL –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑ XML —Ñ–∞–π–ª–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö PostgreSQL —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: Stream-–æ–±—Ä–∞–±–æ—Ç–∫–∞ XML, –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –∫–æ—Ä—É—Ç–∏–Ω—ã –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ZIP, TAR.GZ, TAR.BZ2, 7Z –∏ –¥—Ä—É–≥–∏—Ö –∞—Ä—Ö–∏–≤–æ–≤
- **–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–æ–∫**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ XML —Ñ–∞–π–ª–æ–≤ (–≤–∫–ª—é—á–∞—è –∫–∏—Ä–∏–ª–ª–∏—Ü—É)
- **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î**: –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, upsert –æ–ø–µ—Ä–∞—Ü–∏–∏
- **–ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: JSON —Ñ–∞–π–ª—ã –º–∞–ø–ø–∏–Ω–≥–æ–≤, .env —Ñ–∞–π–ª—ã
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –æ—à–∏–±–æ–∫

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Java 11+
- Kotlin
- PostgreSQL —Å–µ—Ä–≤–µ—Ä
- Gradle 6.8+

## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —Å–±–æ—Ä–∫–∞

### –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone <repository-url>
cd xml-to-pg-etl

# –°–±–æ—Ä–∫–∞ JAR —Ñ–∞–π–ª–∞
./gradlew build shadowJar

# –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏
java -jar build/libs/xml-to-pg-etl-1.0-all.jar --help
```

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
- kotlinx-cli –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
- HikariCP –¥–ª—è pool-–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î
- Jackson –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- StAX –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ XML
- Apache Commons Compress –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ –∞—Ä—Ö–∏–≤–æ–≤

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### .env —Ñ–∞–π–ª

–°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

```env
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
DB_HOST=localhost
DB_PORT=5432
DB_USER=username
DB_PASSWORD=password
DB_DATABASE=database_name

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –º–∞–ø–ø–∏–Ω–≥–æ–≤
MAPPINGS_FILE=./mappings.json

# –§–ª–∞–≥–∏ –æ—á–∏—Å—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
REMOVE_ARCHIVES_AFTER_UNPACK=false
REMOVE_XML_AFTER_IMPORT=false
```

### –§–∞–π–ª –º–∞–ø–ø–∏–Ω–≥–æ–≤ (mappings.json)

```json
[
  {
    "xmlFile": ".*\\.xml$",
    "xmlTag": "item",
    "table": "products",
    "schema": "public",
    "uniqueColumns": ["id"],
    "batchSize": 1000,
    "attributes": {
      "name": "product_name",
      "price": "price",
      "category": "category_id"
    }
  },
  {
    "xmlFile": "users\\.xml",
    "xmlTag": "user",
    "table": "users",
    "schema": "auth",
    "uniqueColumns": ["email"],
    "batchSize": 500,
    "attributes": {
      "name": "full_name",
      "email": "email_address",
      "created_at": "registration_date"
    }
  }
]
```

## üìñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å

```bash
java -jar <jar-file> --env <env-file> --xml <xml-source> [--extract-dir <directory>]
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

- `--env`, `-e`: **(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)** –ü—É—Ç—å –∫ .env —Ñ–∞–π–ª—É —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- `--xml`, `-x`: **(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)** –ü—É—Ç—å –∫ XML —Ñ–∞–π–ª–∞–º, –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–ª–∏ –∞—Ä—Ö–∏–≤—É
- `--extract-dir`, `-d`: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ –∞—Ä—Ö–∏–≤–æ–≤ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è)

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö XML —Ñ–∞–π–ª–æ–≤

```bash
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ XML —Ñ–∞–π–ª–∞
java -jar app.jar --env .env --xml ./data.xml

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö XML —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
java -jar app.jar --env .env --xml ./xml_files/
```

#### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤

```bash
# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –≤ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
java -jar app.jar --env .env --xml ./data.zip

# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
java -jar app.jar --env .env --xml ./archive.tar.gz --extract-dir ./extracted
```

#### 3. –§–ª–∞–≥–∏ –æ—á–∏—Å—Ç–∫–∏

```bash
# –£–¥–∞–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–æ–≤ –ø–æ—Å–ª–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏
REMOVE_ARCHIVES_AFTER_UNPACK=true java -jar app.jar --env .env --xml ./data.zip

# –£–¥–∞–ª–µ–Ω–∏–µ XML —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞
REMOVE_XML_AFTER_IMPORT=true java -jar app.jar --env .env --xml ./data.xml
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/main/kotlin/
‚îú‚îÄ‚îÄ Main.kt              # –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ config.kt            # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ MappingTable.kt     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∞–ø–ø–∏–Ω–≥–æ–≤
‚îú‚îÄ‚îÄ PostgresUpserter.kt # –í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL
‚îú‚îÄ‚îÄ db.kt               # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
‚îú‚îÄ‚îÄ xml.kt              # XML –ø–∞—Ä—Å–µ—Ä
‚îú‚îÄ‚îÄ archive.kt          # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤
‚îî‚îÄ‚îÄ ...
```

## üîß –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

### XML —Ñ–æ—Ä–º–∞—Ç—ã
- –§–∞–π–ª—ã XML —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∫–æ–¥–∏—Ä–æ–≤–∫–∞–º–∏ (UTF-8, UTF-16, CP1251, KOI8-R)
- –í–∫–ª—é—á–∞—è –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ BOM –∏ XML declaration

### –ê—Ä—Ö–∏–≤—ã
- ZIP (.zip)
- TAR (.tar)
- TAR.GZ (.tar.gz, .tgz)
- TAR.BZ2 (.tar.bz2, .tbz2)
- 7Z (.7z)
- GZIP (.gz)
- BZIP2 (.bz2)

### –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
–í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã:
- –°—Ç—Ä–æ–∫–∏: VARCHAR, TEXT, CHAR
- –ß–∏—Å–ª–∞: INT, BIGINT, DECIMAL, FLOAT, DOUBLE
- –î–∞—Ç—ã: DATE, TIME, TIMESTAMP
- –õ–æ–≥–∏—á–µ—Å–∫–∏–µ: BOOLEAN
- –ë–∏–Ω–∞—Ä–Ω—ã–µ: BYTES, BLOB

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –î–æ 4 –∫–æ—Ä—É—Ç–∏–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ)
- **Batch –≤—Å—Ç–∞–≤–∫–∏**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–æ–≤ (batchSize)
- **Connection pooling**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **Stream –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –ù–∏–∑–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–∞—Ö

## üö® –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –∞—Ä—Ö–∏–≤–∞: 1GB
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏: 1,000,000 –∑–∞–ø–∏—Å–µ–π
- PostgreSQL –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –¥–ª–∏–Ω—É –∏–º–µ–Ω —Ç–∞–±–ª–∏—Ü –∏ –∫–æ–ª–æ–Ω–æ–∫ (63 —Å–∏–º–≤–æ–ª–∞)

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Java. –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
- **INFO**: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
- **WARNING**: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- **SEVERE**: –û—à–∏–±–∫–∏, –ø—Ä–µ—Ä—ã–≤–∞—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫—É

–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ Java:

```bash
java -Djava.util.logging.config.file=logging.properties -jar app.jar --env .env --xml data.xml
```
