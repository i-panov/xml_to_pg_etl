# XML to PostgreSQL ETL

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è Kotlin CLI —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ XML —Ñ–∞–π–ª–æ–≤ –≤ PostgreSQL —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–ª–æ–∂–Ω—ã—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ –∞—Ä—Ö–∏–≤–æ–≤.

## üéØ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **üöÑ –ü–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: Event-based XML –ø–∞—Ä—Å–∏–Ω–≥ –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–≥–æ —Ñ–∞–π–ª–∞ –≤ –ø–∞–º—è—Ç—å
- **‚ö° –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º**: –ö–æ—Ä—É—Ç–∏–Ω—ã –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ XML ‚Üí –∑–∞–ø–∏—Å—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü
- **üì¶ –£–º–Ω–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ ZIP, TAR.GZ, TAR.BZ2, 7Z –∏ –¥—Ä—É–≥–∏—Ö –∞—Ä—Ö–∏–≤–æ–≤
- **üåê –ö–æ–¥–∏—Ä–æ–≤–∫–∏**: –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ BOM –∏ XML declaration (UTF-8, UTF-16, Windows-1251, KOI8-R)
- **üé≠ –ì–∏–±–∫–∏–µ –º–∞–ø–ø–∏–Ω–≥–∏**:
    - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ regex-–≥—Ä—É–ø–ø—ã
    - JSON –æ–±—ä–µ–∫—Ç—ã –∏ –º–∞—Å—Å–∏–≤—ã –ø—Ä—è–º–æ –∏–∑ XML
    - –ú–∞–ø–ø–∏–Ω–≥ –æ–¥–Ω–æ–≥–æ XML –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü
    - Enum-–≤–∞–ª–∏–¥–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
- **üíæ UPSERT –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**: `ON CONFLICT DO UPDATE` –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
- **üîí –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å**: Batch-–≤—Å—Ç–∞–≤–∫–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ retry –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö —Å–±–æ—è—Ö
- **üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –æ—à–∏–±–æ–∫

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **Java**: 21+ (–¥–ª—è –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ virtual threads –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö API)
- **PostgreSQL**: 11+ (–¥–ª—è `ON CONFLICT` –∏ JSON/JSONB)
- **Gradle**: 8.5+ (–¥–ª—è Kotlin 2.x)

## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –°–±–æ—Ä–∫–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤

```bash
git clone <repository-url>
cd xml-to-pg-etl

# –°–±–æ—Ä–∫–∞ fat JAR
./gradlew shadowJar

# –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ build/libs/xml_to_pg_etl.jar
```

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```kotlin
// –û—Å–Ω–æ–≤–Ω—ã–µ
kotlinx-coroutines-core 1.10.2    // –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º
HikariCP 7.0.2                    // Connection pooling
postgresql 42.7.5                 // JDBC –¥—Ä–∞–π–≤–µ—Ä
commons-compress 1.28.0           // –ê—Ä—Ö–∏–≤—ã
jackson 2.19.2                    // JSON –∫–æ–Ω—Ñ–∏–≥
clikt 5.0.1                       // CLI
ktoml 0.7.1                       // TOML –∫–æ–Ω—Ñ–∏–≥
logback 1.5.18                    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª (TOML)

–°–æ–∑–¥–∞–π—Ç–µ `config.toml`:

```toml
# –ü—É—Ç—å –∫ –º–∞–ø–ø–∏–Ω–≥–∞–º
mappingsFile = "./mappings.json"

# –û–ø—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏
removeArchivesAfterUnpack = false
removeXmlAfterImport = false

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
stopOnError = false

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –∞—Ä—Ö–∏–≤–µ (–±–∞–π—Ç—ã)
maxArchiveItemSize = 1073741824  # 1 GB

[db]
host = "localhost"
port = 5432
user = "etl_user"
password = "secure_password"
database = "analytics"

[db.props]
connectionTimeout = 30      # —Å–µ–∫—É–Ω–¥—ã
idleTimeout = 120          # —Å–µ–∫—É–Ω–¥—ã
maxLifetime = 1200         # —Å–µ–∫—É–Ω–¥—ã (20 –º–∏–Ω—É—Ç)
validationTimeout = 5      # —Å–µ–∫—É–Ω–¥—ã
socketTimeout = 900        # —Å–µ–∫—É–Ω–¥—ã (15 –º–∏–Ω—É—Ç)
schema = "public"          # —Å—Ö–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
appName = "XML_ETL"        # –∏–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ pg_stat_activity
```

### 2. –§–∞–π–ª –º–∞–ø–ø–∏–Ω–≥–æ–≤ (JSON)

**–ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä** (–æ–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞):

```json
[
  {
    "xml": {
      "files": ["products_\\d{8}\\.xml"],
      "rootPath": ["catalog", "product"],
      "values": {
        "id": {
          "path": ["id"],
          "type": "ATTRIBUTE",
          "required": true
        },
        "name": {
          "path": ["name"],
          "type": "CONTENT"
        },
        "price": {
          "path": ["price"],
          "type": "CONTENT"
        }
      }
    },
    "db": {
      "products": {
        "unique_columns": ["id"],
        "batch_size": 1000
      }
    }
  }
]
```

**–°–ª–æ–∂–Ω—ã–π –ø—Ä–∏–º–µ—Ä** (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü + JSON + –≤–∞–ª–∏–¥–∞—Ü–∏—è):

```json
[
  {
    "xml": {
      "files": ["orders_(?<date>\\d{8})_(?<region>\\w+)\\.xml"],
      "rootPath": ["orders", "order"],
      "values": {
        "shop.order_id": {
          "path": ["id"],
          "type": "ATTRIBUTE",
          "required": true
        },
        "shop.customer_name": {
          "path": ["customer", "name"],
          "type": "CONTENT"
        },
        "shop.status": {
          "path": ["status"],
          "type": "ATTRIBUTE",
          "required": true
        },
        "items.order_id": {
          "path": ["id"],
          "type": "ATTRIBUTE"
        },
        "items.products": {
          "path": ["items", "item"],
          "type": "JSON_ARRAY",
          "structure": {
            "sku": {
              "path": ["sku"],
              "type": "ATTRIBUTE"
            },
            "quantity": {
              "path": ["qty"],
              "type": "CONTENT"
            },
            "price": {
              "path": ["price"],
              "type": "CONTENT"
            }
          }
        }
      },
      "enums": {
        "shop.status": ["new", "processing", "shipped", "delivered"]
      }
    },
    "db": {
      "shop.orders": {
        "unique_columns": ["order_id"],
        "batch_size": 500,
        "filename_groups_to_columns": {
          "date": "order_date",
          "region": "region_code"
        }
      },
      "shop.order_items": {
        "unique_columns": ["order_id"],
        "batch_size": 1000
      }
    }
  }
]
```

### 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∞–ø–ø–∏–Ω–≥–∞

#### XML —Å–µ–∫—Ü–∏—è

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `files` | `string[]` | Regex-–ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã `(?<name>...)` |
| `rootPath` | `string[]` | –ü—É—Ç—å –æ—Ç –∫–æ—Ä–Ω—è XML –¥–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è —ç–ª–µ–º–µ–Ω—Ç–∞-–∑–∞–ø–∏—Å–∏ |
| `values` | `object` | –ú–∞–ø–ø–∏–Ω–≥ XML ‚Üí –∫–æ–ª–æ–Ω–∫–∏. –ö–ª—é—á: `table.column` –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ `column` |
| `enums` | `object` | –°–ª–æ–≤–∞—Ä—å –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ |

#### –¢–∏–ø—ã –∑–Ω–∞—á–µ–Ω–∏–π (`type`)

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|-----|----------|--------|
| `ATTRIBUTE` | –ê—Ç—Ä–∏–±—É—Ç —ç–ª–µ–º–µ–Ω—Ç–∞ | `<item id="123">` ‚Üí `id` |
| `CONTENT` | –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ | `<name>Product</name>` ‚Üí `Product` |
| `JSON_OBJECT` | –û–±—ä–µ–∫—Ç JSON –∏–∑ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ | `{"field": "value"}` |
| `JSON_ARRAY` | –ú–∞—Å—Å–∏–≤ JSON –∏–∑ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ | `[{"id": 1}, {"id": 2}]` |

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–Ω–∞—á–µ–Ω–∏–π

```json
{
  "table.column": {
    "path": ["path", "to", "element"],
    "type": "CONTENT",
    "required": true,        // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è
    "not_for_save": false,   // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    "structure": {...}       // –î–ª—è JSON_OBJECT/JSON_ARRAY
  }
}
```

#### DB —Å–µ–∫—Ü–∏—è

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `unique_columns` | `string[]` | –ö–æ–ª–æ–Ω–∫–∏ –¥–ª—è `ON CONFLICT` |
| `batch_size` | `int` | –†–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞ –¥–ª—è batch insert (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 500) |
| `filename_groups_to_columns` | `object` | –ú–∞–ø–ø–∏–Ω–≥ regex-–≥—Ä—É–ø–ø –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ ‚Üí –∫–æ–ª–æ–Ω–∫–∏ |

## üìñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å

```bash
java -jar xml_to_pg_etl.jar \
  --env config.toml \
  --xml <–∏—Å—Ç–æ—á–Ω–∏–∫> \
  [--extract-dir <–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è>]
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –§–ª–∞–≥ | –ö–æ—Ä–æ—Ç–∫–∏–π | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|--------------|----------|
| `--env` | `-e` | ‚úÖ | –ü—É—Ç—å –∫ TOML –∫–æ–Ω—Ñ–∏–≥—É |
| `--xml` | `-x` | ‚úÖ | XML —Ñ–∞–π–ª, –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∏–ª–∏ –∞—Ä—Ö–∏–≤ |
| `--extract-dir` | `-d` | ‚ùå | –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ (–∏–Ω–∞—á–µ temp) |

### –ü—Ä–∏–º–µ—Ä—ã

#### 1. –û–¥–∏–Ω XML —Ñ–∞–π–ª

```bash
java -jar xml_to_pg_etl.jar -e config.toml -x data.xml
```

#### 2. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å XML

```bash
java -jar xml_to_pg_etl.jar -e config.toml -x /data/xml_files/
```

–û–±—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ `*.xml` + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–∞–∫—É–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∞—Ä—Ö–∏–≤—ã.

#### 3. –ê—Ä—Ö–∏–≤

```bash
# –í–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
java -jar xml_to_pg_etl.jar -e config.toml -x export.zip

# –í —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
java -jar xml_to_pg_etl.jar -e config.toml -x export.tar.gz -d /tmp/extracted
```

#### 4. –° –æ—á–∏—Å—Ç–∫–æ–π

```bash
# –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥:
removeArchivesAfterUnpack = true
removeXmlAfterImport = true

java -jar xml_to_pg_etl.jar -e config.toml -x data.zip
```

#### 5. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

```bash
# –í –∫–æ–Ω—Ñ–∏–≥–µ:
stopOnError = true

java -jar xml_to_pg_etl.jar -e config.toml -x data.xml
```

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É—Ç–∏–ª–∏—Ç–∞ –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/main/kotlin/ru/my/
‚îú‚îÄ‚îÄ Main.kt                      # Entry point + pipeline –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ config.kt                    # –ü–∞—Ä—Å–∏–Ω–≥ TOML, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ HikariCP
‚îú‚îÄ‚îÄ mappings.kt                  # –ú–æ–¥–µ–ª—å –º–∞–ø–ø–∏–Ω–≥–æ–≤ + –≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ archive.kt                   # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤
‚îú‚îÄ‚îÄ streams.kt                   # Streaming copy —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ä–∞–∑–º–µ—Ä–∞
‚îÇ
‚îú‚îÄ‚îÄ xml/
‚îÇ   ‚îú‚îÄ‚îÄ xml_events.kt           # StAX –ø–∞—Ä—Å–µ—Ä ‚Üí XmlEvent sequence
‚îÇ   ‚îú‚îÄ‚îÄ xml_nodes.kt            # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π ‚Üí XmlNode –¥–µ—Ä–µ–≤–æ
‚îÇ   ‚îú‚îÄ‚îÄ xml_filters.kt          # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–∞–ø–ø–∏–Ω–≥–∞–º
‚îÇ   ‚îî‚îÄ‚îÄ xml_utils.kt            # –î–µ—Ç–µ–∫—Ü–∏—è –∫–æ–¥–∏—Ä–æ–≤–∫–∏ (BOM + XML decl)
‚îÇ
‚îî‚îÄ‚îÄ db/
    ‚îú‚îÄ‚îÄ db.kt                   # –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è JDBC + type mapping
    ‚îî‚îÄ‚îÄ PostgresUpserter.kt     # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UPSERT SQL + batch execute
```

### –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏

```
–ò—Å—Ç–æ—á–Ω–∏–∫ ‚Üí –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ ‚Üí –ü–∞—Ä—Å–∏–Ω–≥ ‚Üí –ú–∞–ø–ø–∏–Ω–≥ ‚Üí –ë–∞—Ç—á–∏–Ω–≥ ‚Üí Upsert
   ‚Üì           ‚Üì           ‚Üì          ‚Üì         ‚Üì        ‚Üì
Archive    Flow<Path>  Sequence   Channel   List    PostgreSQL
  .zip      xml files   <XmlNode>  buffered  <Map>   transaction
```

1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ**: `Flow<Path>` –∏–∑ –∞—Ä—Ö–∏–≤–∞/–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
2. **–ü–∞—Ä—Å–∏–Ω–≥**: StAX ‚Üí `Sequence<XmlEvent>` ‚Üí `Sequence<XmlNode>`
3. **–ú–∞–ø–ø–∏–Ω–≥**: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ `XmlValueConfig` ‚Üí `Map<String, String>`
4. **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: Producer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –∫–∞–Ω–∞–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã
5. **–ë–∞—Ç—á–∏–Ω–≥**: Consumers —Å–æ–±–∏—Ä–∞—é—Ç –±–∞—Ç—á–∏ –∏ –ø–∏—à—É—Ç –≤ –ë–î
6. **Upsert**: `INSERT ... ON CONFLICT (unique_cols) DO UPDATE`

### –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º

```kotlin
// Main.kt
val concurrency = Runtime.getRuntime().availableProcessors()

xmlFiles
  .flatMapMerge(concurrency) { xmlFile ->
    // –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    flow { 
      processXmlToMultipleTables(xmlFile, db)
    }
  }

// –í–Ω—É—Ç—Ä–∏ processXmlToMultipleTables:
// - 1 producer –∫–æ—Ä—É—Ç–∏–Ω–∞ (–ø–∞—Ä—Å–∏–Ω–≥ XML)
// - N consumer –∫–æ—Ä—É—Ç–∏–Ω (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Ç–∞–±–ª–∏—Ü—É)
```

## üîß –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

### –ê—Ä—Ö–∏–≤—ã

| –§–æ—Ä–º–∞—Ç | –†–∞—Å—à–∏—Ä–µ–Ω–∏—è | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|--------|------------|------------|
| ZIP | `.zip` | Deflate, Store |
| TAR | `.tar` | |
| TAR.GZ | `.tar.gz`, `.tgz` | |
| TAR.BZ2 | `.tar.bz2`, `.tbz2` | |
| GZIP | `.gz` | –û–¥–∏–Ω–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã |
| BZIP2 | `.bz2` | –û–¥–∏–Ω–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã |
| 7-Zip | `.7z` | |

**–í–∞–∂–Ω–æ**: –í–ª–æ–∂–µ–Ω–Ω—ã–µ –∞—Ä—Ö–∏–≤—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è (–∞—Ä—Ö–∏–≤ –≤–Ω—É—Ç—Ä–∏ –∞—Ä—Ö–∏–≤–∞).

### –ö–æ–¥–∏—Ä–æ–≤–∫–∏ XML

–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑:
1. **BOM** (Byte Order Mark): UTF-8, UTF-16BE/LE, UTF-32BE/LE
2. **XML declaration**: `<?xml version="1.0" encoding="windows-1251"?>`
3. **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é**: UTF-8

–ü–æ–¥–¥–µ—Ä–∂–∫–∞: –≤—Å–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –∏–∑ `java.nio.charset.Charset`.

### –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL

| SQL —Ç–∏–ø | Kotlin —Ç–∏–ø | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|---------|------------|------------|
| `VARCHAR`, `TEXT` | `String` | |
| `INTEGER` | `Int` | |
| `BIGINT` | `Long` | |
| `DECIMAL`, `NUMERIC` | `BigDecimal` | –ó–∞–ø—è—Ç–∞—è ‚Üí —Ç–æ—á–∫–∞ |
| `FLOAT`, `DOUBLE` | `Double` | –ó–∞–ø—è—Ç–∞—è ‚Üí —Ç–æ—á–∫–∞ |
| `BOOLEAN` | `Boolean` | `true/false/1/0/yes/no` |
| `DATE` | `LocalDate` | `YYYY-MM-DD` |
| `TIME` | `LocalTime` | `HH:mm:ss` |
| `TIMESTAMP` | `LocalDateTime` | ISO-8601 |
| `TIMESTAMPTZ` | `OffsetDateTime` | ISO-8601 —Å timezone |
| `BYTEA` | `ByteArray` | Hex string ‚Üí bytes |
| `JSON`, `JSONB` | `String` | –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç |

**Nullable –∫–æ–ª–æ–Ω–∫–∏**: –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí `NULL`. –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ `NOT NULL` ‚Üí –æ—à–∏–±–∫–∞.

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ë–µ–Ω—á–º–∞—Ä–∫–∏

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ |
|----------|-------------------|-----------|
| 1M –∑–∞–ø–∏—Å–µ–π (10 –∫–æ–ª–æ–Ω–æ–∫) | ~60 —Å–µ–∫ | `batchSize=1000`, 8 cores |
| –ê—Ä—Ö–∏–≤ 500MB (XML –≤–Ω—É—Ç—Ä–∏) | ~120 —Å–µ–∫ | –í–∫–ª—é—á–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É |
| 10 XML ‚Üí 5 —Ç–∞–±–ª–∏—Ü | ~45 —Å–µ–∫ | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å |

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

#### Connection Pool

```toml
# config.toml
[db.props]
connectionTimeout = 30
maxLifetime = 1200
socketTimeout = 900
```

–§–æ—Ä–º—É–ª–∞: `poolSize = min(cores * 2, 16)`, –≥–¥–µ cores = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä.

#### Batch Size

```json
{
  "db": {
    "table_name": {
      "batch_size": 1000  // ‚Üë –¥–ª—è —à–∏—Ä–æ–∫–∏—Ö —Ç–∞–±–ª–∏—Ü, ‚Üì –¥–ª—è —É–∑–∫–∏—Ö
    }
  }
}
```

**–≠–º–ø–∏—Ä–∏–∫–∞**:
- 5-10 –∫–æ–ª–æ–Ω–æ–∫ ‚Üí `batch_size: 1000-2000`
- 20+ –∫–æ–ª–æ–Ω–æ–∫ ‚Üí `batch_size: 500`
- JSON –∫–æ–ª–æ–Ω–∫–∏ ‚Üí `batch_size: 200-300`

#### Retry

```kotlin
// Main.kt (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
.retry(3) { e ->
  // –ü–æ–≤—Ç–æ—Ä –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö
  e is SQLException && 
    ("socket" in e.message || "timeout" in e.message)
}
```

## üö® –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –õ–∏–º–∏—Ç | –û–±—Ö–æ–¥ |
|----------|-------|-------|
| –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –∞—Ä—Ö–∏–≤–µ | 1 GB | `maxArchiveItemSize` –≤ –∫–æ–Ω—Ñ–∏–≥–µ |
| –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ | 1,000,000 —Å—Ç—Ä–æ–∫ | –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ |
| –î–ª–∏–Ω–∞ –∏–º–µ–Ω–∏ —Ç–∞–±–ª–∏—Ü—ã/–∫–æ–ª–æ–Ω–∫–∏ | 63 —Å–∏–º–≤–æ–ª–∞ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ PostgreSQL |
| –ì–ª—É–±–∏–Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ XML | –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –ø–∞–º—è—Ç—å—é JVM |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á | `cores * 2` | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç connection pool |

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –£—Ä–æ–≤–Ω–∏

```
INFO  ‚Üí –°—Ç–∞—Ä—Ç/–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
WARN  ‚Üí –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–∞–ø–∏—Å–∏
ERROR ‚Üí –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞, SQL –æ—à–∏–±–∫–∏
DEBUG ‚Üí –î–µ—Ç–∞–ª–∏ –±–∞—Ç—á–µ–π (–ø—Ä–∏ duration > 60s)
```

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
INFO  Extracting archive: data.zip to /tmp/xml_to_pg_etl_12345
INFO  Detected encoding for export.xml: windows-1251
INFO  Starting processing export.xml -> orders. Query: INSERT INTO "orders" ...
INFO  Processed 50000 records (path: orders/order) from export.xml
INFO  Completed export.xml -> orders: 120 batches, 119847 rows
INFO  Successfully loaded export.xml: 119847 total rows across 2 tables
INFO  Processing complete: 5 files found, 5 processed successfully, 0 with errors
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞

`logback.xml`:

```xml
<configuration>
  <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
    </encoder>
  </appender>

  <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–æ–¥–∞ -->
  <logger name="ru.my" level="DEBUG"/>
  
  <!-- –ú–µ–Ω—å—à–µ —à—É–º–∞ –æ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫ -->
  <logger name="com.zaxxer.hikari" level="WARN"/>
  <logger name="org.apache.commons.compress" level="WARN"/>

  <root level="INFO">
    <appender-ref ref="STDOUT"/>
  </root>
</configuration>
```

## üêõ Troubleshooting

### `OutOfMemoryError`

**–ü—Ä–∏—á–∏–Ω–∞**: –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –±–∞—Ç—á–∏ –∏–ª–∏ –æ–≥—Ä–æ–º–Ω—ã–µ JSON –ø–æ–ª—è.

**–†–µ—à–µ–Ω–∏–µ**:
```bash
java -Xmx4G -jar xml_to_pg_etl.jar ...  # –£–≤–µ–ª–∏—á–∏—Ç—å heap
```

–ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å `batch_size` –≤ –º–∞–ø–ø–∏–Ω–≥–µ.

### `Connection timeout`

**–ü—Ä–∏—á–∏–Ω–∞**: Connection pool –∏—Å—á–µ—Ä–ø–∞–Ω.

**–†–µ—à–µ–Ω–∏–µ**:
```toml
[db.props]
connectionTimeout = 60  # –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç
```

–ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º (–º–µ–Ω—å—à–µ —Ñ–∞–π–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ).

### `Encoding issues (–∫—Ä–∞–∫–æ–∑—è–±—Ä—ã)`

**–ü—Ä–∏—á–∏–Ω–∞**: –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å `encoding` –≤ XML declaration:
```xml
<?xml version="1.0" encoding="windows-1251"?>
```

### `No mapping found for file.xml`

**–ü—Ä–∏—á–∏–Ω–∞**: –ò–º—è —Ñ–∞–π–ª–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç regex –≤ `files`.

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω:
```json
{
  "files": [".*\\.xml"]  // –°–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–æ
  "files": ["data_\\d+\\.xml"]  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
}
```

### `Column not found in table`

**–ü—Ä–∏—á–∏–Ω–∞**: –û–ø–µ—á–∞—Ç–∫–∞ –≤ –∏–º–µ–Ω–∏ –∫–æ–ª–æ–Ω–∫–∏ –∏–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DDL —Ç–∞–±–ª–∏—Ü—ã: `\d table_name` –≤ psql
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ **–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: –ù–µ—Ç SQL injection
- ‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: Batch –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
- ‚úÖ **Credentials –≤ –∫–æ–Ω—Ñ–∏–≥–µ**: –ù–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å –≤ –∫–æ–¥–µ!
- ‚ö†Ô∏è **Path traversal**: –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –∞—Ä—Ö–∏–≤–∞–º–∏ –∏–∑ –Ω–µ–Ω–∞–¥—ë–∂–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

## üìù Changelog

### v1.0 (—Ç–µ–∫—É—â–∞—è)

- ‚ú® –ü–µ—Ä–µ—Ö–æ–¥ —Å `.env` –Ω–∞ TOML –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- ‚ú® –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSON –æ–±—ä–µ–∫—Ç–æ–≤/–º–∞—Å—Å–∏–≤–æ–≤ –≤ –º–∞–ø–ø–∏–Ω–≥–µ
- ‚ú® –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ regex
- ‚ú® –ú–∞–ø–ø–∏–Ω–≥ –æ–¥–Ω–æ–≥–æ XML –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü
- ‚ú® Enum-–≤–∞–ª–∏–¥–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
- ‚ú® –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–æ–∫ —á–µ—Ä–µ–∑ BOM
- üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω memory leak –≤ –∫–∞–Ω–∞–ª–∞—Ö
- ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è connection pool sizing
